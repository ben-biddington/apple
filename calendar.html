<html>
<head>
<style type="text/css">
  table#events tr td { border: 1px solid red; padding:2px; }
  div#calendar { border:1px solid green; width:350px; }
  div#calendar span.day { padding:2px; border:1px solid #EEE; width:50px; height:50px; float:left; margin:1px; }
  div#calendar span.busy {background-color:red; color:white; font-weight:bold;}
</style>
</head>
<body>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="jquery-1.6.3.min.js"></script>
  <script language="javascript">
    google.load("gdata", "1");
    google.setOnLoadCallback(getMyFeed);
 
    console.log("year => "+ query("y"))
    console.log("month => "+ query("m"))

    var daysInMonth = new Date(parseInt(query("y")), parseInt(query("m")), 0).getDate();

    console.log("Days in " + query("m") + " = " + daysInMonth);

    var myService;
    var feedUrl = "https://www.google.com/calendar/feeds/vddp2rq2f0j1asv103n6jps2og@group.calendar.google.com/public/full";

    function onOkay(feedRoot) {
      console.log("Title => " + feedRoot.feed.title.toString());
      console.log("Entries => " + feedRoot.feed.getEntries());

      var entries = feedRoot.feed.getEntries();

      // see: http://code.google.com/apis/gdata/jsdoc/2.2/google/gdata/atom/Entry.html
      // see: http://code.google.com/apis/gdata/jsdoc/2.2/google/gdata/EventEntry.html
      for (var item in entries) {
        var entry = entries[item];
    
        var times = entry.getTimes();
        var startDateTime = "Unknown";
        var endDateTime = "Unknown";
        var timezoneOffsetInMinutes = "Unknown"

        if (times.length > 0) {
          var theDate = times[0].getStartTime().getDate();
          startDateTime = theDate.toDateString(); 
          var endDate = times[0].getEndTime().getDate();
          endDateTime = endDate.toDateString();
          timezoneOffsetInMinutes = theDate.getTimezoneOffset();
        }

        $("<tr><td>" + startDateTime + "</td><td>" + endDateTime + "</td><td>" + entry.getTitle().getText() + "</td></tr>").appendTo("#events");
      }

      $("<p>Time zone offset (hours): " + timezoneOffsetInMinutes/60 + "</p>").appendTo("#events");

      buildCalendar(year(), month(), entries);
    }

    function year() {
      return query("y") != null ? parseInt(query("y")) : 2011;
    }

    function month() {
      return query("m") != null ? parseInt(query("m")) : 9;    
    }

    function onError(e) { }

    // see: http://gdata-javascript-client.googlecode.com/svn/trunk/samples/calendar/simple_sample/simple_sample.html
    // see: http://code.google.com/apis/gdata/jsdoc/2.2/index.html
    function getMyFeed() {
      calendar = new google.gdata.calendar.CalendarService('cl');
      var query = new google.gdata.calendar.CalendarEventQuery(feedUrl);
      query.setOrderBy('starttime');

      calendar.getEventsFeed(query, onOkay, onError);
    }
    
    function query(name) {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regexS = "[\\?&]" + name + "=([^&#]*)";
      var regex = new RegExp(regexS);
      var results = regex.exec(window.location.href);
      
      if(results == null)
        return null;
      else
        return decodeURIComponent(results[1].replace(/\+/g, " "));
     }

    function buildCalendar(year, month, entries) {
      var daysInMonth = new Date(year, month, 0).getDate();

      $("<span>" + monthName(month) + " " + year + "</span>").appendTo("#calendar-title")

      for (var i = 1; i <= daysInMonth; i++) {
        var busy = isBusy(entries, new Date(year, month-1, i));

	var cssClass = busy ? "day busy" : "day";		   
			   
        $("<span class=\"" + cssClass +"\" id=\"calendar_day_" + i + "\">" + i + "</span>").appendTo("#calendar");
      }
    } 

    // see: http://code.google.com/apis/gdata/jsdoc/2.2/google/gdata/When.html
    function isBusy(entries, when) {
      when = zeroTime(when);
      
      for (var i = 0; i < entries.length; i++) {
        var entry = entries[i];
	var times = entry.getTimes();

        if (times.length > 0) {
          var startDate = zeroTime(times[0].getStartTime().getDate());
          var endDate = zeroTime(times[0].getEndTime().getDate());
	  
	  var isInInterval = startDate <= when && when < endDate; 		  

          if (isInInterval) {
	   console.log(startDate + " <= " + when + " <= " + endDate);
           return true;
          }
        }
      }	

      return false;		   
    }

    function zeroTime(date) {
      var result = new Date(date);

      result.setHours(0);		   
      result.setMinutes(0);		   
      result.setSeconds(0);

      return result;	      
    }			   

    function monthName(num) {
      months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      return months[num - 1];			   
    }			   
  </script> 

  <table id="events">
    <tr>
      <td>Starts</td>
      <td>Ends</td>
      <td>Name</td>
    </tr>
  </table>
  <div id="calendar">
    <div id="calendar-title"></div>
  </div>
</body>
</html>
